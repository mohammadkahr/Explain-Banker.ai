<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Explainable Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --bg: #121212;
            --card: #1e1e2f;
            --text: #e0e0e0;
            --purple: #bb86fc;
            --purple-dark: #3700b3;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', Tahoma, sans-serif;
        }

        .card {
            background-color: var(--card);
            border: 1px solid #333;
            box-shadow: 0 4px 15px rgba(0,0,0,0.6);
        }

        .card-header {
            background: rgba(187, 134, 252, 0.1);
            color: var(--purple);
            border-bottom: 1px solid #333;
            font-weight: bold;
        }

        /* List Styling */
        .list-group-item {
            background-color: #2c2c35;
            color: white;
            border: 1px solid #444;
            margin-bottom: 6px;
            border-radius: 6px !important;
            cursor: pointer;
            transition: 0.2s;
        }
        .list-group-item:hover {
            background-color: #3b3b4b;
        }
        .list-group-item.active-item {
            background-color: var(--purple) !important;
            color: black !important;
            font-weight: bold;
            border-color: var(--purple);
        }

        /* Plots */
        .plot-box {
            background: #181820;
            border-radius: 8px;
            padding: 10px;
            min-height: 300px;
            border: 1px dashed #444;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        .plot-img {
            max-width: 100%;
            height: auto;
            border-radius: 6px;
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            backdrop-filter: blur(5px);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #121212; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--purple); }

        .table-dark {
            background-color: #2c2c35;
            color: #fff;
        }
    </style>
</head>

<body>

<!-- Loader -->
<div id="loading-overlay">
    <div class="spinner-border text-info" role="status" style="width: 3rem; height: 3rem;"></div>
    <h5 class="mt-3 text-light">Analyzing Model Behavior...</h5>
    <small class="text-muted">Generating SHAP, LIME & Counterfactuals</small>
</div>

<div class="container-fluid p-4">

    <div class="row mb-4">
        <div class="col text-center">
            <h3 style="color: var(--purple);">
                <i class="fas fa-brain"></i> Explainable AI Dashboard
            </h3>
        </div>
    </div>

    <div class="row">
        <!-- LEFT PANEL: Inputs -->
        <div class="col-lg-3 mb-3">
            <div class="card h-100">
                <div class="card-header">
                    <i class="fas fa-list"></i> Select Sample
                </div>
                <div class="card-body p-2" style="height: 500px; overflow-y: auto;">
                    <div class="list-group">
                        {% for row in samples %}
                        <button class="list-group-item d-flex justify-content-between align-items-center"
                                onclick="selectSample(this, {{ row['id'] }})">
                            <span>Sample ID: <strong>{{ row['id'] }}</strong></span>
                            <i class="fas fa-chevron-right small"></i>
                        </button>
                        {% endfor %}
                    </div>
                </div>
                <div class="card-footer bg-transparent border-top border-secondary">
                    <label class="form-label text-muted small">Select Model</label>
                    <select id="modelSelect" class="form-select bg-dark text-light border-secondary mb-3">
                        <option value="" disabled selected>-- Choose Model --</option>
                        {% for m in model_list %}
                        <option value="{{ m }}">{{ m }}</option>
                        {% endfor %}
                    </select>

                    <input type="hidden" id="selectedId">

                    <button class="btn w-100 fw-bold"
                            style="background: var(--purple); color: black;"
                            onclick="runAnalysis()">
                        <i class="fas fa-bolt"></i> ANALYZE
                    </button>
                </div>
            </div>
        </div>

        <!-- RIGHT PANEL: Results -->
        <div class="col-lg-9">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-chart-bar"></i> XAI Results</span>
                    <span id="predictionBadge" class="badge bg-secondary p-2">No Prediction Yet</span>
                </div>

                <div class="card-body">
                    <!-- Tabs -->
                    <ul class="nav nav-tabs border-secondary" id="myTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active text-light" data-bs-toggle="tab" data-bs-target="#shap" type="button">SHAP (Global/Local)</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link text-light" data-bs-toggle="tab" data-bs-target="#lime" type="button">LIME (Local)</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link text-light" data-bs-toggle="tab" data-bs-target="#dice" type="button">Counterfactuals (DiCE)</button>
                        </li>
                    </ul>

                    <div class="tab-content mt-3">
                        <!-- SHAP -->
                        <div class="tab-pane fade show active" id="shap">
                            <div id="shapPlot" class="plot-box">
                                <span class="text-muted"><i class="fas fa-arrow-left"></i> Select a sample & model to begin</span>
                            </div>
                        </div>

                        <!-- LIME -->
                        <div class="tab-pane fade" id="lime">
                            <div id="limePlot" class="plot-box">
                                <span class="text-muted">Waiting for analysis...</span>
                            </div>
                        </div>

                        <!-- DiCE -->
                        <div class="tab-pane fade" id="dice">
                            <h6 class="text-info mt-2">What needs to change to flip the prediction?</h6>
                            <div id="diceTable" class="table-responsive mt-3">
                                <span class="text-muted">Waiting for analysis...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function selectSample(btn, id) {
        // Remove active class from all
        document.querySelectorAll('.list-group-item').forEach(b => b.classList.remove('active-item'));
        // Add to clicked
        btn.classList.add('active-item');
        document.getElementById('selectedId').value = id;
    }

    function runAnalysis() {
        const id = document.getElementById('selectedId').value;
        const model = document.getElementById('modelSelect').value;

        if (!id) {
            alert("Please select a Sample ID from the list.");
            return;
        }
        if (!model) {
            alert("Please select a Model.");
            return;
        }

        // Show Loader
        document.getElementById('loading-overlay').style.display = 'flex';

        const form = new FormData();
        form.append("sample_id", id);
        form.append("model_name", model);

        fetch("/analyze", { method: "POST", body: form })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    alert("Error: " + data.error);
                    return;
                }

                // Update Prediction Badge
                const badge = document.getElementById("predictionBadge");
                const confidence = (data.pred_confidence * 100).toFixed(1);

                badge.innerHTML = `Prediction: <strong>${data.pred_label}</strong> (${confidence}%)`;

                // Color Logic based on class (Yes=Warning/Orange, No=Success/Green - or custom)
                if(data.pred_label === 'Yes') {
                    badge.className = "badge bg-warning text-dark p-2";
                } else {
                    badge.className = "badge bg-success p-2";
                }

                // Update Plots
                const shapContainer = document.getElementById("shapPlot");
                if (data.shap_plot) {
                    shapContainer.innerHTML = `<img src="data:image/png;base64,${data.shap_plot}" class="plot-img">`;
                } else {
                    shapContainer.innerHTML = `<div class="text-danger"><i class="fas fa-exclamation-triangle"></i> SHAP analysis failed via backend.</div>`;
                }

                const limeContainer = document.getElementById("limePlot");
                if (data.lime_plot) {
                    limeContainer.innerHTML = `<img src="data:image/png;base64,${data.lime_plot}" class="plot-img">`;
                } else {
                    limeContainer.innerHTML = `<div class="text-danger"><i class="fas fa-exclamation-triangle"></i> LIME analysis failed.</div>`;
                }

                const diceContainer = document.getElementById("diceTable");
                if (data.dice_html) {
                    diceContainer.innerHTML = data.dice_html;
                } else {
                    diceContainer.innerHTML = `<div class="text-muted">No counterfactuals found or generation failed.</div>`;
                }

            })
            .catch(err => {
                console.error(err);
                alert("Server Connection Error. Check console logs.");
            })
            .finally(() => {
                document.getElementById('loading-overlay').style.display = 'none';
            });
    }
</script>

</body>
</html>